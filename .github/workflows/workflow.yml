name: Sync to Client Repo

on:
  # Triggers when a PR is opened, updated, or reopened
  pull_request:
    branches: [ main ]
    types: [ opened, synchronize, reopened ]

  # Triggers when code is pushed to main (this includes PR merges)
  push:
    branches: [ main ]

jobs:
  validate:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Git
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"

      - name: Run Validation Script
        env:
          ORIGINAL_COMMIT: ${{ github.event.pull_request.head.sha }}
          CLIENT_REPO: 'https://gitlab.com/superdesk-saas/devsecops-target-repo'
          CLIENT_PAT: ${{ secrets.CLIENT_PAT }}
          BRANCH: 'main'
        run: bash validate.sh "$GITHUB_SERVER_URL/$GITHUB_REPOSITORY.git" "$CLIENT_REPO" "$BRANCH"

  sync:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install git-filter-repo
        run: pip install git-filter-repo

      - name: Set up Git
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"

      - name: Run Push Script
        env:
          CLIENT_USERNAME: 'superdesk_support@superdesk.solutions'  # e.g., 'oauth2' or your email/username
          CLIENT_PAT: ${{ secrets.CLIENT_PAT }}
          CLIENT_REPO: 'https://gitlab.com/superdesk-saas/devsecops-target-repo'
          BRANCH: 'main'
          ORIGINAL_COMMIT: ${{ github.sha }}
          NEW_BRANCH: "update-from-push-${{ github.sha }}"
        run: bash push.sh "$GITHUB_SERVER_URL/$GITHUB_REPOSITORY.git" "$CLIENT_REPO" "$BRANCH" "$ORIGINAL_COMMIT" "$NEW_BRANCH"

# NOTE: for github SCM code push: 
# sync:
#   runs-on: ubuntu-latest
#   needs: validate
#   if: success()
#   steps:
#     - name: Checkout code
#       uses: actions/checkout@v4
#       with:
#         fetch-depth: 0

#     - name: Install git-filter-repo
#       run: pip install git-filter-repo

#     - name: Set up Git
#       run: |
#         git config --global user.name "GitHub Action"
#         git config --global user.email "action@github.com"

#     - name: Install GitHub CLI
#       run: |
#         sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-key C99B11D28041DD01
#         sudo apt-add-repository "deb [arch=amd64] https://cli.github.com/packages stable main"
#         sudo apt update
#         sudo apt install gh

#     - name: Authenticate GitHub CLI
#       run: echo "${{ secrets.CLIENT_PAT }}" | gh auth login --with-token

#     - name: Run Push Script
#       env:
#         CLIENT_PAT: ${{ secrets.CLIENT_PAT }}
#         CLIENT_REPO: ${{ secrets.CLIENT_REPO_URL }}
#         BRANCH: ${{ github.event.pull_request.base.ref }}
#         ORIGINAL_COMMIT: ${{ github.event.pull_request.head.sha }}
#         NEW_BRANCH: "update-from-pr-${{ github.event.pull_request.number }}"
#       run: bash push.sh "$GITHUB_SERVER_URL/$GITHUB_REPOSITORY.git" "$CLIENT_REPO" "$BRANCH" "$ORIGINAL_COMMIT" "$NEW_BRANCH"
